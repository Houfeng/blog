<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="Houfeng"><link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32"><link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16"><link rel="manifest" href="/favicons/manifest.json"><link rel="mask-icon" href="/favicons/safari-pinned-tab.svg" color="#5bbad5"><meta name="theme-color" content="#ffffff"><meta name="description" content="一句话介绍Confman是一个强大的配置文件加载器，无论你喜欢yaml、cson、json、properties、plist、ini、toml、xml还是js，都能满足你的愿望，并且更加简单、更加强大。"><meta name="keywords" content=""><title>Confman - 针对「Node 应用」的配置文件加载模块 · Houfeng's Blog</title><link rel="icon" href="/favicons/favicon.ico"><link rel="canonical" href="http://blog.houfeng.net/2016/07/29/confman/"><link rel="stylesheet" href="/fonts/iconfont/iconfont.css"><link rel="stylesheet" href="/css/style.css"><script type="text/javascript">var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?3F16290d6dfe4977c6ba2d32fb7a483731";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script></head><body><div style="display:none;"><img src="/favicons/300x300.png"></div><div id="main"><header><a href="/." class="logo">Houfeng's Blog</a><ul class="nav"><li class="nav-link"><a href="/" target="_self">首页</a></li><li class="nav-link"><a href="/archives/" target="_self">归档</a></li><li class="nav-link"><a href="/about/" target="_self">关于</a></li></ul></header><section id="container"><article class="post"><h1 class="post-title">Confman - 针对「Node 应用」的配置文件加载模块</h1><span class="post-time">Jul 29, 2016</span><div id="sidebar" class="post-sidebar"><h3 class="heading">目录</h3><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#一句话介绍"><span class="toc-text">一句话介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#支持的特性"><span class="toc-text">支持的特性</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#现在就安装"><span class="toc-text">现在就安装</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#来几个示例"><span class="toc-text">来几个示例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#不同的环境配置"><span class="toc-text">不同的环境配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#配置文件相互引用"><span class="toc-text">配置文件相互引用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#基于目录的多文件配置"><span class="toc-text">基于目录的多文件配置</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#添加新格式"><span class="toc-text">添加新格式</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#新的扩展名"><span class="toc-text">新的扩展名</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#内置的指令"><span class="toc-text">内置的指令</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#自定义指令"><span class="toc-text">自定义指令</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#其它的问题"><span class="toc-text">其它的问题</span></a></li></ol></div><div class="post-content"><h1 id="一句话介绍"><a href="#一句话介绍" class="headerlink" title="一句话介绍"></a>一句话介绍</h1><p>Confman 是一个强大的配置文件加载器，无论你喜欢 yaml 、cson、json、properties、plist、ini、toml、xml 还是 js，都能满足你的愿望，并且更加简单、更加强大。</p>
<p><a href="http://badge.fury.io/js/confman" target="_blank" rel="external"><img src="https://badge.fury.io/js/confman.svg" alt="npm version"></a> <a href="https://travis-ci.org/Houfeng/confman" target="_blank" rel="external"><img src="https://travis-ci.org/Houfeng/confman.svg?branch=master" alt="Build Status"></a> </p>
<a id="more"></a>
<h1 id="支持的特性"><a href="#支持的特性" class="headerlink" title="支持的特性"></a>支持的特性</h1><ul>
<li>支持多种配置文件格式，默认包括 yaml/cson/json/properties/plist/ini/toml/xml/js </li>
<li>支持配置文件相互引用，无论何种格式都可以「引用其它任意格式」的配置文件</li>
<li>支持「基于目录」的多文件配置</li>
<li>支持「环境配置」，区分加载生产、测试等不同的配置</li>
<li>可以非常方便的「扩展」新的配置文件格式</li>
<li>可以「混合使用」不同的配置文件格式</li>
<li>内置多种「指令」，并可轻易的扩展新的指令</li>
</ul>
<h1 id="现在就安装"><a href="#现在就安装" class="headerlink" title="现在就安装"></a>现在就安装</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ npm install confman --save</div></pre></td></tr></table></figure>
<h1 id="来几个示例"><a href="#来几个示例" class="headerlink" title="来几个示例"></a>来几个示例</h1><h4 id="不同的环境配置"><a href="#不同的环境配置" class="headerlink" title="不同的环境配置"></a>不同的环境配置</h4><p>目录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">app</div><div class="line">├── index.js</div><div class="line">├── config.dev.yaml</div><div class="line">├── config.prod.yaml</div><div class="line">└── config.yaml</div></pre></td></tr></table></figure></p>
<p>index.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> confman = <span class="built_in">require</span>(<span class="string">'confman'</span>);</div><div class="line"><span class="keyword">const</span> configs = confman.load(<span class="string">`<span class="subst">$&#123;__dirname&#125;</span>/config`</span>);</div><div class="line"><span class="built_in">console</span>.log(configs);</div></pre></td></tr></table></figure></p>
<p>启动应用<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ NODE_ENV=prod node index.js</div></pre></td></tr></table></figure></p>
<p>通过指定 <strong>NODE_ENV</strong> 可以加载指定的「环境配置文件 config.prod.yaml」，并和「默认配置 config.yaml」进行合并,<br>如果有相同的配置，「环境配置会覆盖默认配置」</p>
<h4 id="配置文件相互引用"><a href="#配置文件相互引用" class="headerlink" title="配置文件相互引用"></a>配置文件相互引用</h4><p>文件一: test1.yaml<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="attr">name:</span> test1</div><div class="line"><span class="comment">#可以使用 $require 引用其它文件</span></div><div class="line"><span class="attr">child:</span> $requrie ./test2</div></pre></td></tr></table></figure></p>
<p>文件二: test2.json<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"name"</span>: <span class="string">"test2"</span>,</div><div class="line">   <span class="attr">"child"</span>: <span class="string">"$require other-file"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>$require</strong> 可以在任意支持的格式的配置文件中使用</p>
<h4 id="基于目录的多文件配置"><a href="#基于目录的多文件配置" class="headerlink" title="基于目录的多文件配置"></a>基于目录的多文件配置</h4><p>目录结构<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">├── config</div><div class="line">│   ├── conn.yaml</div><div class="line">│   ├── index.yaml</div><div class="line">│   └── mvc.yaml</div><div class="line">├── config.dev</div><div class="line">│   └── conn.yaml</div><div class="line">├── config.prod</div><div class="line">│   └── conn.yaml</div><div class="line">└── index.js</div></pre></td></tr></table></figure></p>
<p>index.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> confman = <span class="built_in">require</span>(<span class="string">'confman'</span>);</div><div class="line"><span class="keyword">const</span> configs = confman.load(<span class="string">`<span class="subst">$&#123;__dirname&#125;</span>/config`</span>);</div><div class="line"><span class="built_in">console</span>.log(configs);</div></pre></td></tr></table></figure></p>
<h1 id="添加新格式"><a href="#添加新格式" class="headerlink" title="添加新格式"></a>添加新格式</h1><p>其实，多数情况你不需要这么做，如果确实有需要，你可这样编写一个自定义 <strong>loader</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">  extname: <span class="string">'.xxx'</span>,</div><div class="line">  load: <span class="function"><span class="keyword">function</span> (<span class="params">configPath</span>) </span>&#123;</div><div class="line">    <span class="comment">//...</span></div><div class="line">    <span class="keyword">return</span> configs;</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>注册自定义 loader<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">confman.loaders.push(<span class="built_in">require</span>(<span class="string">'your-loader-path'</span>));</div></pre></td></tr></table></figure></p>
<h1 id="新的扩展名"><a href="#新的扩展名" class="headerlink" title="新的扩展名"></a>新的扩展名</h1><p>方式一，映射到一个已经添加的 loader<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">confman.loaders.push(&#123;</div><div class="line">  extname: <span class="string">'.xxx'</span>,</div><div class="line">  loader: <span class="string">'.yaml'</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>方式二，直接映射到一个未添加的自定义 loader<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">confman.loaders.push(&#123;</div><div class="line">  extname: <span class="string">'.xxx'</span>,</div><div class="line">  loader: <span class="built_in">require</span>(<span class="string">'your-loader-path'</span>)</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h1 id="内置的指令"><a href="#内置的指令" class="headerlink" title="内置的指令"></a>内置的指令</h1><p>如上边用到的 <strong>$require</strong>，Confman 允许使用指令完成某些配置，内置的指令包括:</p>
<ul>
<li>$require 引用指令，用于引用其它配置文件，参数为相对于当前文件的相对路径或绝对路径</li>
<li>$calc 计算指令，用于计算一个表达式，如 $calc root.baseUrl+”/xxx” (表达式中可用变量有 root:根对象，parent:父对象，self:当前对象)</li>
<li>$read 读取指令，用于读取一个文本文件，参数为相对于当前文件的相对路径或绝对路径</li>
</ul>
<p>示例 example.yaml<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="attr">name:</span> example</div><div class="line"><span class="attr">test1:</span> $require ./test1.json</div><div class="line"><span class="attr">test2:</span> $read ./test2.txt</div><div class="line"><span class="attr">test3:</span> $calc root.name + <span class="string">":test3"</span></div></pre></td></tr></table></figure></p>
<p>假如 <strong>test1.json</strong> 的内容为 <strong>“name”: “test1”</strong>，<strong>test2.txt</strong> 的内容为 <strong>my name is test2</strong>,<br>通过 <strong>Confman.load(‘./example</strong> 加载 <strong>example</strong> 的结果为：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"name"</span>: <span class="string">"example"</span>,</div><div class="line">  <span class="attr">"test1"</span>: &#123; <span class="attr">"name"</span>: <span class="string">"test1"</span> &#125;,</div><div class="line">  <span class="attr">"test2"</span>: <span class="string">"my name is test2"</span>,</div><div class="line">  <span class="attr">"test3"</span>: <span class="string">"example:test3"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="自定义指令"><a href="#自定义指令" class="headerlink" title="自定义指令"></a>自定义指令</h1><p>编写一个自定义指令的代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">  name: <span class="string">'xxx'</span>,</div><div class="line">  exec: <span class="function"><span class="keyword">function</span>(<span class="params">context</span>)</span>&#123;</div><div class="line">    <span class="comment">//context.fromPath 来自哪个配置文件</span></div><div class="line">    <span class="comment">//context.parser 当前 Confman 实例</span></div><div class="line">    <span class="comment">//context.root 根对象</span></div><div class="line">    <span class="comment">//context.parent 父对象</span></div><div class="line">    <span class="comment">//context.self 当前对象</span></div><div class="line">    <span class="comment">//context.name 配置属性名</span></div><div class="line">    <span class="comment">//context.value 指令后的值</span></div><div class="line">    <span class="keyword">return</span> &#123;&#125; <span class="comment">//返回值为指令执行结果</span></div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>注册自定义指令<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">confman.directives.push(<span class="built_in">require</span>(<span class="string">'your_directive_path'</span>));</div></pre></td></tr></table></figure></p>
<h1 id="其它的问题"><a href="#其它的问题" class="headerlink" title="其它的问题"></a>其它的问题</h1><ul>
<li>新的建议或 Bug 请使用 isseus 反馈</li>
<li>贡献代码，请使用 Pull Request，需一并提交相关测试并且不能低于现有覆盖率</li>
</ul>
<blockquote>
<p>现在或将来有可能会用到？那你应该去加个 Star<br>GitHub : <a href="https://github.com/Houfeng/confman" target="_blank" rel="external">https://github.com/Houfeng/confman</a></p>
</blockquote>
</div></article><div class="tags"></div><div class="paginator"><a href="/2016/09/27/node-process-lock/" class="prev"><i class="iconfont icon-left"></i><span> 上一页</span></a><a href="/2016/07/21/cize/" class="next"><span>下一页</span><i class="iconfont icon-right"></i></a></div><section id="comments"><div data-thread-key="http://blog.houfeng.net/2016/07/29/confman/index.html" data-title="Confman - 针对「Node 应用」的配置文件加载模块" data-url="http://blog.houfeng.net/2016/07/29/confman/index.html" class="ds-thread"></div><script type="text/javascript">var duoshuoQuery = {short_name: "houfeng" };
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
})();</script></section></section><footer><div class="copyright"><p class="power">Powered by <a href="https://hexo.io/">Hexo</a> and Theme by <a href="https://github.com/ahonn/hexo-theme-even"> Even</a></p><p class="since">&copy;2009-2016<span class="heart"><i class="iconfont icon-heart"></i></span><span class="author">Houfeng</span></p></div><label id="back2top"><i class="iconfont icon-up"></i></label></footer></div><script src="/js/zepto.min.js"></script><script src="/js/theme.js"></script></body></html>